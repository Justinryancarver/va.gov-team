# CMS Content Caching Strategy

_Replace the previous line with the the title of your project or component and replace the following lines with your name(s), email and the date._  
**Author(s):** Eugene Doan  
**Last Updated:** December 15, 2020  
**Status:** **Draft** | In Review | Approved  
**Approvers:** Dan Shank \[ \], Demian Ginther \[ \], Michael Fleet \[ \], Dror Matalon \[ \]  

## Overview

### Objective

Systems and workflows that need to access the latest CMS content should be able to do so without advanced configuration or permissions (e.g., SOCKS proxy).
Having this access would benefit review instances, the CircleCI build pipeline, and local development. There may also be other use cases.
The intended audience for this document are both users and maintainers of these systems and any others that have a dependency on CMS content.

To support this functionality, this document will outline an approach to setting up a cache of the latest CMS content.
- This not intended to form a sophisticated caching policy with version management and rollback capabilities.
- Instead, the focus is on keeping the latest version the the CMS content updated on a schedule.

This document will not delve into implementation details of how various systems (builds, local development, etc.) will use the cache.

### Background
_The background section should contain information the reader needs to know to understand the problem being solved. This can be a combination of text and links to other documents._

_Do **NOT** describe the solution here. That goes in High Level Design._

A large part of the VA.gov website is static content that is derived from a Drupal-based content management system (CMS). 
Building the static pages of the site involves fetching the content either directly from the Drupal CMS or from a cache in Amazon S3 (Simple Storage Service).

The CMS is hosted in the internal VA network, so the request for its content has to traverse the Trusted Internet Connection (TIC).
- Only systems within the network have direct access to internal services like the CMS.
- External systems, such as local development machines outside of the network, can only access internal services through a SOCKS proxy.
- Publicly hosted services such as review instances or CircleCI pipelines currently have no means of accessing internal services.

To circumvent the need for the SOCKS proxy or a direct internal connection, there is a content cache that's regularly generated by the Jenkins build pipeline.
- The build for each environment (dev, staging, prod) tries to pull the content to fully build the website.
- If the Drupal content pull is successful, the pipeline caches that content in S3. Otherwise, the build uses a previous cache.
- The cache is stored with a key derived from a combination of the environment name and a hash of the GraphQL query that's used to fetch all pages from Drupal.

There have been issues with generating the cache key (department-of-veterans-affairs/va.gov-team#16401) that forced review instances to attempt to directly pull content from Drupal and fail (department-of-veterans-affairs/va.gov-team#16637).
- Review instances are staging-like environments, with website and API integration, used by many veteran-facing services (VFS) teams to test changes within feature branches.
- From the service interruption, it was explained that review instances are in a separate virtual private cloud (VPC) than the internal VPC that hosts internal services like the CMS.
- In addition, because the review instances have configured an Internet gateway, they do not have clearance from VA to peer or otherwise connect with the internal VPC.
- Since they don't have a SOCKS proxy configuration or direct access to the CMS, review instances rely entirely on the cache to build the environment.

The problem with review instances prompted an overarching discussion around revising the content caching strategy.
The goals of that change would be to prevent similar issues and to better support systems that depend on the cache.

As alluded to earlier, direct requests for content from Drupal currently involve GraphQL queries. However, this is going to change.
- There is an ongoing project to overhaul the content build to use what is known as CMS export data, as opposed to the GraphQL query results.
- Naturally, eliminating the GraphQL queries would disrupt the current approach to caching (since the key is generated from those queries) as well as the systems that depend on it.

### High Level Design

Content will be cached in S3 with a constant key such as `latest.tar.bz2` instead of an ever-changing hash-based key.

An Amazon Web Services (AWS) Lambda function will pull the content from Drupal and sync the cache every 5 minutes.

Local development environments, review instances, the CircleCI build, and any other systems would be able to start using this new cache as needed.

## Specifics

### Detailed Design
_Designs that are too detailed for the above High Level Design section belong here. Anything that will require a day or more of work to implement should be described here._

_This is a great place to put APIs, communication protocols, file formats, and the like._

_It is important to include assumptions about what external systems will provide. For example if this system has a method that takes a user id as input, will your implementation assume that the user id is valid? Or if a method has a string parameter, does it assume that the parameter has been sanitized against injection attacks? Having such assumptions explicitly spelled out here before you start implementing increases the chances that misunderstandings will be caught by a reviewer before they lead to bugs or vulnerabilities. Please reference the external system's documentation to justify your assumption whenever possible (and if such documentation doesn't exist, ask the external system's author to document the behavior or at least confirm it in an email)._

_Here's an easy rule of thumb for deciding what to write here: Think of anything that would be a pain to change if you were requested to do so in a code review. If you put that implementation detail in here, you'll be less likely to be asked to change it once you've written all the code._

### Code Location
_The path of the source code in the repository._

### Testing Plan
_How you will verify the behavior of your system. Once the system is written, this section should be updated to reflect the current state of testing and future aspirations._

### Logging
_What your system will record and how._

### Debugging
_How users can debug interactions with your system. When designing a system it's important to think about what tools you can provide to make debugging problems easier. Sometimes it's unclear whether the problem is in your system at all, so a mechanism for isolating a particular interaction and examining it to see if your system behaved as expected is very valuable. Once a system is in use, this is a great place to put tips and recipes for debugging. If this section grows too large, the mechanisms can be summarized here and individual tips can be moved to another document._

### Caveats
_Gotchas, differences between the design and implementation, other potential stumbling blocks for users or maintainers, and their implications and workarounds. Unless something is known to be tricky ahead of time, this section will probably start out empty._

_Rather than deleting it, it's recommended that you keep this section with a simple place holder, since caveats will almost certainly appear down the road._

_To be determined._

### Security Concerns
_This section should describe possible threats (denial of service, malicious requests, etc) and what, if anything, is being done to protect against them. Be sure to list concerns for which you don't have a solution or you believe don't need a solution. Security concerns that we don't need to worry about also belong here (e.g. we don't need to worry about denial of service attacks for this system because it only receives requests from the api server which already has DOS attack protections)._

### Privacy Concerns
_This section should describe any risks related to user data, PII that are added by this new application. Think about flows of user data through systems, places data is stored and logged, places data is displayed to users. Where is user data stored or logged? How long is it stored?_

### Open Questions and Risks
_This section should describe design questions that have not been decided yet, research that needs to be done and potential risks that could make make this system less effective or more difficult to implement._

_Some examples are: Should we communicate using TCP or UDP? How often do we expect our users to interrupt running jobs? This relies on an undocumented third-party API which may be turned off at any point._

_For each question you should include any relevant information you know. For risks you should include estimates of likelihood, cost if they occur and ideas for possible workarounds._

### Work Estimates
_Split the work into milestones that can be delivered, put them in the order that you think they should be done, and estimate roughly how much time you expect it each milestone to take. Ideally each milestone will take one week or less._

### Alternatives
_This section contains alternative solutions to the stated objective, as well as explanations for why they weren't used. In the planning stage, this section is useful for understanding the value added by the proposed solution and why particular solutions were discarded. Once the system has been implemented, this section will inform readers of alternative solutions so they can find the best system to address their needs._

### Future Work
_Features you'd like to (or will need to) add but aren't required for the current release. This is a great place to speculate on potential features and performance improvements._

### Revision History
_The table below should record the major changes to this document. You don't need to add an entry for typo fixes, other small changes or changes before finishing the initial draft._

Date | Revisions Made | Author
-----|----------------|--------
Jan 24, 2020 | Added approvers, status, and privacy concerns. | Andrew Gunsch
Jan 19, 2016 | Initial Draft based off [Arvados's template](https://dev.arvados.org/projects/arvados/wiki/Design_Doc_Template) which is reminiscent of Google's | Albert J. Wong
